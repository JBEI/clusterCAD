{% extends "base.html" %}

{% load domainFilters %}

{% block js_content %}
<script>
jQuery(document).ready(function($) {
    $(".clickable-row").click(function() {
        window.location = $(this).data("href");
    });
    $("[data-toggle=popover]").popover({ trigger: 'hover' });
});
</script>
{% endblock %}

{% block subtitle %}
Similarity hits
{% endblock %}

{% block content %}
<h2>Subunit amino acid sequence blast hits</h2>

<div class="row-fluid">
<div class="col-md-12">
<dl class="dl-horizontal">
<dt>Query sequence</dt>
<dd>
<textarea class="form-control" rows="6">{{ aainput }}</textarea>
</dd>
<dt>Maximum E-value</dt>
<dd>{{ evalue }} </dd>
<dt>Max hits returned</dt>
<dd>{{ maxHits }} </dd>
</dl>
</div>
</div><!--/row-->

<script>
$(document).ready(function(){
    $('[data-domain]').click(function(){
       var domain = $( this ).attr("data-domain");
       var type = $( this ).attr("data-type");
       $('[data-domain="' + domain + '"]').attr("style", "background-color: transparent;"); 
       $('[data-domain="' + domain + '"][data-type="' + type + '"]').attr("style", "background-color: orange;"); 
    });
});
</script>

<div class="row-fluid">
<h3><small>Highlight domains</small></h3>
<div class="btn-group" role="group">
  <div class="btn-group" role="group">
    <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
     AT 
      <span class="caret"></span>
    </button>
    <ul class="dropdown-menu">
      {% for substrate in atsubstrates %}
      <li><a data-domain="AT" data-type="{{ substrate.0 }}">Substrate {{ substrate.0 }}</a></li>
      {% endfor %}
      <li><a data-domain="AT" data-type="clear">Clear highlighting</a></li>
    </ul>
  </div>
  <div class="btn-group" role="group">
    <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
      KR 
      <span class="caret"></span>
    </button>
    <ul class="dropdown-menu">
      {% for type in krtypes %}
      <li><a data-domain="KR" data-type="{{ type.0 }}">Type {{ type.0 }}</a></li>
      {% endfor %}
      <li><a data-domain="KR" data-type="clear">Clear highlighting</a></li>
    </ul>
  </div>
  <div class="btn-group" role="group">
    <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
      DH 
      <span class="caret"></span>
    </button>
    <ul class="dropdown-menu">
      <li><a>Active</a></li>
      <li><a>Inactive</a></li>
    </ul>
  </div>
  <div class="btn-group" role="group">
    <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
      ER 
      <span class="caret"></span>
    </button>
    <ul class="dropdown-menu">
      <li><a>Active</a></li>
      <li><a>Inactive</a></li>
    </ul>
  </div>
  <div class="btn-group" role="group">
    <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
      cMT 
      <span class="caret"></span>
    </button>
    <ul class="dropdown-menu">
      <li><a>Active</a></li>
      <li><a>Inactive</a></li>
    </ul>
  </div>
</div>
</div>

<div class="row-fluid">
<div class="col-md-12">
<table class="table table-hover">
<thead>
<tr>
    <th class="text-right">
        Hit 
    </th>
    <th>
        Cluster
    </th>
    <th>
        Subunit
    </th>
    <th class="text-right">
        HSP
    </th>
    <th class="text-right">
       E-value 
    </th>
    <th class="text-right">
       Bit 
    </th>
    <th class="text-right">
       Query 
    </th>
    <th class="text-right">
       Subject 
    </th>
    <th class="text-right">
        Modules (domains)
    </th>
</tr>
</thead>
<tbody>
{% for alignment in alignments %}
<tr class="clickable-row" data-container="body" data-href="/pks/{{ alignment.subunit.cluster.mibigAccession }}/#{{ alignment.subunit.name }}">
        <td class="text-right" rowspan="{{ alignment.hsps|length }}">
            {{ forloop.counter }}
        </td>
        <td rowspan="{{ alignment.hsps|length }}">
            {{ alignment.subunit.cluster.mibigAccession }}
            {{ alignment.subunit.cluster.description }}
        </td>
        <td rowspan="{{ alignment.hsps|length }}">
            {{ alignment.subunit.name }}
        </td>
        {% for hsp in alignment.hsps %}
            {% if forloop.counter != 1 %}
            <tr class="clickable-row" data-container="body" data-href="/pks/{{ alignment.subunit.cluster.mibigAccession }}/#{{ alignment.subunit.name }}">
            {% endif %}
            <td class="text-right">
                {{ forloop.counter }}
            </td>
            <td class="text-right">
                {{ hsp.hsp.expect|sigfig }}
            </td>
            <td class="text-right">
                {{ hsp.hsp.bits }}
            </td>
            <td class="text-right">
                {{ hsp.hsp.query_start }}..{{ hsp.hsp.query_end }}
            </td>
            <td class="text-right">
                {{ hsp.hsp.sbjct_start }}..{{ hsp.hsp.sbjct_end }}
            </td>
            <td class="text-right">
            {% if hsp.modules|length == 0 %}
                N/A
            {% endif %}
            {% for module in hsp.modules %}{% if forloop.counter != 1 %}<br/>{% endif %}{{ module.module.order }} ({% for domain in module.domains %}{% if forloop.counter != 1 %}, {% endif %}<mark data-domain="{{ domain|classname }}" {% if domain|classname == "KR" %}data-type="{{ domain.type }}"{% endif %}{% if domain|classname == "AT" %}data-type="{{ domain.substrate }}"{% endif %} style="background-color: transparent;">{{ domain|classname }}</mark>{% endfor %}){% endfor %}
            </td>
        {% endfor %}
</tr>
{% endfor %}
</tbody>
</table>
</div>
</div>
{% endblock %}
